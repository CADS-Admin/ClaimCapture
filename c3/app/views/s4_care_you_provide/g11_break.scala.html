@(breakForm: Form[models.domain.Break])(implicit claim: models.domain.Claim, request: Request[AnyContent])

@import utils.helpers.CarersCrypto
@import models.domain.MoreAboutTheCare
@import views.html.helper._
@import views.html.helper.dates._
@import utils.helpers.CarersTemplate._
@import app.Whereabouts._

@dateOfClaimCheckIfSpent35HoursCaringBeforeClaim() = @{
    import language.postfixOps

    val spent35HoursCaringBeforeClaim = claim.questionGroup(MoreAboutTheCare) match {
        case Some(m: MoreAboutTheCare) => m.spent35HoursCaringBeforeClaim.answer == "yes"
        case _ => false
    }

    claim.dateOfClaim.fold("{NO CLAIM DATE}")(dmy =>
        if (spent35HoursCaringBeforeClaim) (dmy - 6 months).`dd/MM/yyyy`
        else dmy.`dd/MM/yyyy`)
}

@main("Break - About the care you provide", Some(breakForm)) {

    @form(action = controllers.s4_care_you_provide.routes.G11Break.submit) {
        <input type="hidden" name="breakID" value='@breakForm("breakID").value.getOrElse(java.util.UUID.randomUUID.toString)'>

        <fieldset class="form-elements">
            <legend>About the break in care since @dateOfClaimCheckIfSpent35HoursCaringBeforeClaim</legend>

            <ul class="group">
                @dateTimePicker(breakForm("start"))

                @dateTimePicker(breakForm("end"))

                @whereabouts(breakForm("whereYou"),
                             Seq("", AtHome, Hospital, Holiday, RespiteCare, Other).map(v => if (v == "") "" -> "Please select" else v -> v),
                             '_label -> Messages("whereYou.location"), 'textAreaHelper -> "60 characters left", 'maxLength -> 60)

                @whereabouts(breakForm("wherePerson"),
                             Seq("", AtHome, Hospital, RespiteCare, CareHome, NursingHome, Other).map(v => if (v == "") "" -> "Please select" else v -> v),
                             '_label -> Messages("wherePerson.location"), 'textAreaHelper -> "60 characters left", 'maxLength -> 60)

                @yesNoRadioGroup(breakForm("medicalDuringBreak"))
            </ul>
        </fieldset>

        <nav class="form-steps">
            <a id="backButton" href="@claim.navigation.previous" class="button secondary" aria-label="Back button">Back</a>
            <button type="submit" name="action" value="next" class="button" aria-label="Next button">Next</button>
        </nav>
    }
}

<script type="text/javascript" src='@routes.Assets.at("javascripts/s4_care_you_provide/g11_break.js")'></script>
<script type="text/javascript" src='@routes.Assets.at("javascripts/textAreaCounter.js")'></script>

<script type="text/javascript">
    $(function(){
        window.areaCounter({selector: "@CarersCrypto.encryptAES("whereYou_location_other")", maxChars: 60});
        window.areaCounter({selector: "@CarersCrypto.encryptAES("wherePerson_location_other")", maxChars: 60});
    })
</script>

@import play.api.Play
@import play.api.Play.current

@if(!Play.isTest) {
    <script>
        $(function() {
            var startPicker = $('#start_date.datepicker').pickadate().pickadate('picker');
            var endPicker = $('#end_date.datepicker').pickadate().pickadate('picker');

            var startValue = $('#start_date.datepicker').val();
            var endValue = $('#end_date.datepicker').val();

            if (startValue !== '') {
                var startDate = new Date(startValue);
                endPicker.set('min', startDate);
                endPicker.set('highlight', startDate);
            }

            if (endValue !== '') {
                startPicker.set('max', new Date(endValue));
            }

            startPicker.on('set', function(event) {
                if ('select' in event) {
                    var startValue = $("input[name='start.date.hidden']").val();
                    var startDate = new Date(startValue);
                    var endMinDate = endPicker.get('min');

                    if (!isFinite(endMinDate.year) || endMinDate.year != startDate.getFullYear() || endMinDate.month != startDate.getMonth() || (endMinDate.date) != startDate.getDate()) {
                        endPicker.set('min', startDate);
                    }
                }

                if ('clear' in event) {
                    endPicker.set('min', false);
                }
            });

            endPicker.on('set', function(event) {
                if ('select' in event) {
                    var endValue = $("input[name='end.date.hidden']").val();
                    var endDate = new Date(endValue);
                    var startMaxDate = startPicker.get('max');

                    if (!isFinite(startMaxDate.year) || startMaxDate.year != endDate.getFullYear() || startMaxDate.month != endDate.getMonth() || (startMaxDate.date) != endDate.getDate()) {
                        startPicker.set('max', endDate);
                    }
                }

                if ('clear' in event) {
                    startPicker.set('max', false);
                }
            });
        });
    </script>
}